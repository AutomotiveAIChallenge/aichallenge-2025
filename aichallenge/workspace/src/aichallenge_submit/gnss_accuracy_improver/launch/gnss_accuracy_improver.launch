<launch>
  <!-- aichallenge環境用 GNSS精度向上システム -->
  <arg name="namespace" default="" />
  <arg name="config_file" default="$(find gnss_accuracy_improver)/config/kart_racing_config.json" />
  <arg name="enable_diagnostics" default="true" />
  <arg name="enable_logging" default="false" />
  
  <!-- メインノード -->
  <group ns="$(arg namespace)">
    <node name="gnss_accuracy_improver" 
          pkg="gnss_accuracy_improver" 
          type="gnss_accuracy_improver_node.py" 
          output="screen"
          respawn="true"
          respawn_delay="2">
      
      <!-- 基本設定 -->
      <param name="config_file" value="$(arg config_file)" />
      
      <!-- トピック設定（aichallenge環境に合わせる） -->
      <param name="input_gnss_topic" value="/racing_kart_gnss_poser/gnss" />
      <param name="output_gnss_topic" value="/gnss_accuracy_improver/improved_gnss" />
      <param name="velocity_topic" value="/racing_kart_gnss_poser/velocity" />
      
      <!-- 診断・統計トピック -->
      <param name="diagnostics_topic" value="/gnss_accuracy_improver/diagnostics" />
      <param name="statistics_topic" value="/gnss_accuracy_improver/statistics" />
      
      <!-- タイミング設定（カートレーシング用） -->
      <param name="signal_timeout" value="3.0" />
      <param name="statistics_interval" value="5.0" />
      <param name="diagnostics_interval" value="2.0" />
      
      <!-- フレーム設定 -->
      <param name="output_frame" value="base_link" />
      
      <!-- カート設定 -->
      <param name="enable_velocity_integration" value="true" />
      <param name="kart_mode" value="true" />
      
      <!-- デフォルト値 -->
      <param name="default_satellites" value="8" />
      <param name="default_hdop" value="1.5" />
    </node>
  </group>
  
  <!-- 診断情報の可視化（オプション） -->
  <node name="diagnostics_agg" 
        pkg="diagnostic_aggregator" 
        type="aggregator_node"
        if="$(arg enable_diagnostics)">
    <rosparam>
      pub_rate: 1.0
      analyzers:
        gnss:
          type: diagnostic_aggregator/GenericAnalyzer
          path: GNSS
          contains: ['gnss_accuracy_improver']
    </rosparam>
  </node>
  
  <!-- ログ記録（オプション） -->
  <group if="$(arg enable_logging)">
    <node name="gnss_logger" 
          pkg="rosbag" 
          type="record"
          args="-o /tmp/aichallenge_gnss 
                /racing_kart_gnss_poser/gnss
                /gnss_accuracy_improver/improved_gnss
                /gnss_accuracy_improver/statistics
                /gnss_accuracy_improver/diagnostics" />
  </group>
</launch>
